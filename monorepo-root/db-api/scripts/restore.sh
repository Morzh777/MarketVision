#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö MarketVision –∏–∑ –±—ç–∫–∞–ø–∞

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏
DB_NAME="marketvision"
DB_USER="marketvision"
BACKUP_DIR="/backups"

echo "üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö MarketVision..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞—Ä–≥—É–º–µ–Ω—Ç—ã
if [ $# -eq 0 ]; then
    echo "‚ùå –£–∫–∞–∂–∏—Ç–µ —Ñ–∞–π–ª –±—ç–∫–∞–ø–∞!"
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 <backup_file>"
    echo ""
    echo "–î–æ—Å—Ç—É–ø–Ω—ã–µ –±—ç–∫–∞–ø—ã:"
    ls -lh ${BACKUP_DIR}/marketvision_backup_*.sql 2>/dev/null || echo "–ë—ç–∫–∞–ø—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
    exit 1
fi

BACKUP_FILE=$1

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
if [ ! -f "${BACKUP_DIR}/${BACKUP_FILE}" ] && [ ! -f "${BACKUP_DIR}/${BACKUP_FILE}.gz" ]; then
    echo "‚ùå –§–∞–π–ª –±—ç–∫–∞–ø–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω: ${BACKUP_FILE}"
    echo "–î–æ—Å—Ç—É–ø–Ω—ã–µ –±—ç–∫–∞–ø—ã:"
    echo "   –°–∂–∞—Ç—ã–µ (–ø–æ–ª–Ω—ã–µ):"
    ls -lh ${BACKUP_DIR}/marketvision_backup_*.gz 2>/dev/null || echo "   –°–∂–∞—Ç—ã–µ –±—ç–∫–∞–ø—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
    echo "   SQL (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π):"
    ls -lh ${BACKUP_DIR}/marketvision_backup_*.sql 2>/dev/null || echo "   SQL –±—ç–∫–∞–ø—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω
if ! docker ps | grep -q marketvision-postgres; then
    echo "‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä PostgreSQL –Ω–µ –∑–∞–ø—É—â–µ–Ω!"
    exit 1
fi

echo "‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ—Ç —Ç–µ–∫—É—â—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö!"
echo "–§–∞–π–ª –±—ç–∫–∞–ø–∞: ${BACKUP_FILE}"
read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å? (y/N): " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "‚ùå –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ"
    exit 1
fi

echo "üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –±—ç–∫–∞–ø–∞: ${BACKUP_FILE}"

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º API –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ API..."
docker stop marketvision-database-api 2>/dev/null || true

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –±—ç–∫–∞–ø–∞ –∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º
if [ -f "${BACKUP_DIR}/${BACKUP_FILE}.gz" ]; then
    echo "üì¶ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ —Å–∂–∞—Ç–æ–≥–æ –±—ç–∫–∞–ø–∞..."
    gunzip -c ${BACKUP_DIR}/${BACKUP_FILE}.gz | docker exec -i marketvision-postgres psql -U ${DB_USER} -d ${DB_NAME}
elif [ -f "${BACKUP_DIR}/${BACKUP_FILE}" ]; then
    echo "üì¶ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ SQL –±—ç–∫–∞–ø–∞..."
    docker exec -i marketvision-postgres psql -U ${DB_USER} -d ${DB_NAME} < ${BACKUP_DIR}/${BACKUP_FILE}
else
    echo "‚ùå –§–∞–π–ª –±—ç–∫–∞–ø–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ø–µ—à–Ω–æ—Å—Ç—å
if [ $? -eq 0 ]; then
    echo "‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É—Å–ø–µ—à–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!"
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º API –æ–±—Ä–∞—Ç–Ω–æ
    echo "üöÄ –ó–∞–ø—É—Å–∫ API..."
    docker start marketvision-database-api
    
    echo "üéâ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è!"
    echo "üöÄ –ó–∞–ø—É—Å–∫ API..."
    docker start marketvision-database-api
    exit 1
fi 