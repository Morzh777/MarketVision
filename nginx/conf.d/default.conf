# --- Upstreams ---
upstream frontend {
    server host.docker.internal:3006;
}
upstream db_api_rest {
    # Указываем REST порт для db-api
    server marketvision-database-api:3004;
}
upstream product_filter_service {
    server marketvision-product-aggregator:3001;
}

# --- gRPC Upstreams ---
upstream grpc_wb {
    # gRPC порт для wb-api
    server marketvision-wb-parser:3000;
}
upstream grpc_ozon {
    server marketvision-ozon-parser:3002;
}
upstream grpc_db {
    server marketvision-database-api:50051;
}
# --------------------

# --- HTTP Server (редирект на HTTPS) ---
server {
    listen 80;
    server_name localhost;
    return 301 https://$host$request_uri;
}
# ----------------------------------------

# --- ЕДИНЫЙ HTTPS СЕРВЕР (REST, gRPC, Frontend) ---
server {
    # Слушаем стандартный HTTPS порт, включаем HTTP/2 для gRPC
    listen 443 ssl;
    http2 on;
    server_name localhost;

    # SSL Сертификаты
    ssl_certificate /etc/nginx/certs/server.crt;
    ssl_certificate_key /etc/nginx/certs/server.key;

    # --- gRPC роуты ---
    # wb-api
    location /raw_product.RawProductService/ {
        grpc_pass grpc://grpc_wb;
        grpc_set_header Host $host;
        grpc_set_header X-Real-IP $remote_addr;
        grpc_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        grpc_set_header X-Forwarded-Proto $scheme;
    }

    # ozon-api - используем другой путь
    location /ozon_product.RawProductService/ {
        grpc_pass grpc://grpc_ozon;
        grpc_set_header Host $host;
        grpc_set_header X-Real-IP $remote_addr;
        grpc_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        grpc_set_header X-Forwarded-Proto $scheme;
    }

    # db-api (пример, нужно будет добавить реальные пути)
    # location /db_api.DbService {
    #    grpc_pass grpc://grpc_db;
    # }

    # --- REST API роуты ---
    location /api/ {
        proxy_pass http://db_api_rest;
        proxy_set_header Host $host;
    }
    location /products/ {
        proxy_pass http://product_filter_service;
        proxy_set_header Host $host;
    }

    # --- Next.js Frontend ---
    location / {
        proxy_pass http://frontend;
        proxy_set_header Host $host;
    }
}
# ----------------------------------------------------