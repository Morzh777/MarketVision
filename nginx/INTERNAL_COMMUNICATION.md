# üîó –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –ø–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö –≤ MarketVision

## üìã –û–±–∑–æ—Ä –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

### –¢–µ–∫—É—â–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
```
üåê –í–Ω–µ—à–Ω–∏–µ –∑–∞–ø—Ä–æ—Å—ã (—Å SSL):
‚îú‚îÄ‚îÄ HTTPS (443) ‚Üí nginx ‚Üí product-filter-service
‚îú‚îÄ‚îÄ HTTPS (443) ‚Üí nginx ‚Üí db-api (REST)
‚îî‚îÄ‚îÄ HTTPS (443) ‚Üí nginx ‚Üí frontend (Next.js)

üîó –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ gRPC –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (–±–µ–∑ SSL):
‚îú‚îÄ‚îÄ product-filter-service ‚Üí marketvision-wb-parser:3000
‚îú‚îÄ‚îÄ product-filter-service ‚Üí marketvision-ozon-parser:3002
‚îî‚îÄ‚îÄ product-filter-service ‚Üí marketvision-database-api:50051
```

## üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –í–Ω–µ—à–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (—á–µ—Ä–µ–∑ nginx)
- **SSL/TLS**: –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –≤—Å–µ—Ö –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- **–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã**: –°–∞–º–æ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –≤ `/etc/nginx/certs/`
- **–ó–∞–≥–æ–ª–æ–≤–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏**: HSTS, X-Frame-Options, X-Content-Type-Options
- **–¢–∞–π–º–∞—É—Ç—ã**: –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è DDoS

### –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (Docker network)
- **SSL**: –û—Ç–∫–ª—é—á–µ–Ω –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- **–°–µ—Ç—å**: –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è Docker network `marketvision-net`
- **IP-—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è**: –¢–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ IP-–∞–¥—Ä–µ—Å–∞ Docker
- **Keepalive**: –ù–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Nginx

### –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã
```nginx
# –í–Ω–µ—à–Ω–∏–µ upstreams —Å keepalive
upstream product_filter_service {
    server marketvision-product-aggregator:3001;
    keepalive 32;  # –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
}

# –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ gRPC upstreams (–¥–ª—è –±—É–¥—É—â–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è)
upstream grpc_wb {
    server marketvision-wb-parser:3000;
    keepalive 32;
}
```

### SSL –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
```nginx
# –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ SSL –ø—Ä–æ—Ç–æ–∫–æ–ª—ã
ssl_protocols TLSv1.2 TLSv1.3;

# –ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ —à–∏—Ñ—Ä—ã
ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;

# –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ SSL —Å–µ—Å—Å–∏–π
ssl_session_cache shared:SSL:10m;
ssl_session_timeout 10m;
```

### –ó–∞–≥–æ–ª–æ–≤–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
```nginx
# –ó–∞—â–∏—Ç–∞ –æ—Ç XSS
add_header X-XSS-Protection "1; mode=block" always;

# –ó–∞—â–∏—Ç–∞ –æ—Ç clickjacking
add_header X-Frame-Options "SAMEORIGIN" always;

# –ó–∞—â–∏—Ç–∞ –æ—Ç MIME sniffing
add_header X-Content-Type-Options "nosniff" always;

# HSTS
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
```

## üöÄ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### Keepalive —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
- **–í–Ω–µ—à–Ω–∏–µ**: 32 —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –Ω–∞ upstream
- **–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ**: 32 —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –Ω–∞ upstream
- **–¢–∞–π–º–∞—É—Ç**: 60 —Å–µ–∫—É–Ω–¥

### –ë—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è
```nginx
proxy_buffering on;
proxy_buffer_size 4k;
proxy_buffers 8 4k;
proxy_busy_buffers_size 8k;
```

### –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
```nginx
# –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ
proxy_cache_valid 200 1h;
proxy_cache_valid 404 1m;

# –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
}
```

## üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### Health checks
```yaml
# Docker health check –¥–ª—è nginx
healthcheck:
  test: ["CMD", "curl", "-f", "http://localhost:8080/nginx-health"]
  interval: 30s
  timeout: 10s
  retries: 3
  start_period: 40s
```

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
```yaml
# –†–æ—Ç–∞—Ü–∏—è –ª–æ–≥–æ–≤
logging:
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"
```

## üìä –¢–∞–π–º–∞—É—Ç—ã

### –í–Ω–µ—à–Ω–∏–µ –∑–∞–ø—Ä–æ—Å—ã
- **Connect**: 60s
- **Send**: 60s
- **Read**: 60s

### –ü–∞—Ä—Å–∏–Ω–≥ (—Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Ç–∞–π–º–∞—É—Ç—ã)
- **Read**: 300s (5 –º–∏–Ω—É—Ç)
- **Send**: 300s (5 –º–∏–Ω—É—Ç)

## üîí IP-—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è

### –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Å–µ—Ä–≤–µ—Ä (–ø–æ—Ä—Ç 8080)
```nginx
# –†–∞–∑—Ä–µ—à–∞–µ–º —Ç–æ–ª—å–∫–æ Docker networks
allow 172.16.0.0/12;  # Docker network
allow 192.168.0.0/16; # Docker network
deny all;
```

## üö® –õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
1. ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π SSL –¥–ª—è –≤—Å–µ—Ö –≤–Ω–µ—à–Ω–∏—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
2. ‚úÖ –ù–∞—Å—Ç—Ä–æ–π –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
3. ‚úÖ –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–π –¥–æ—Å—Ç—É–ø –∫ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º –ø–æ—Ä—Ç–∞–º
4. ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ SSL –ø—Ä–æ—Ç–æ–∫–æ–ª—ã
5. ‚úÖ –ù–∞—Å—Ç—Ä–æ–π HSTS –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ HTTPS

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
1. ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π keepalive —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
2. ‚úÖ –ù–∞—Å—Ç—Ä–æ–π –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—é
3. ‚úÖ –ö—ç—à–∏—Ä—É–π —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã
4. ‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π —Ç–∞–π–º–∞—É—Ç—ã
5. ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä—å –ª–æ–≥–∏ –∏ –º–µ—Ç—Ä–∏–∫–∏

### –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å
1. ‚úÖ –ù–∞—Å—Ç—Ä–æ–π health checks
2. ‚úÖ –†–æ—Ç–∞—Ü–∏—è –ª–æ–≥–æ–≤
3. ‚úÖ Graceful shutdown
4. ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–µ—Å—É—Ä—Å–æ–≤
5. ‚úÖ Backup –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π

## üîß –ö–æ–º–∞–Ω–¥—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ nginx
```bash
cd nginx
docker-compose restart nginx
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ health check
curl http://localhost:8080/nginx-health

# –ü—Ä–æ–≤–µ—Ä–∫–∞ SSL
curl -k https://localhost/products/search

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞
curl -I http://localhost/api/products
```

### –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
```bash
# –õ–æ–≥–∏ nginx
docker logs marketvision-nginx-proxy

# –õ–æ–≥–∏ —Å follow
docker logs -f marketvision-nginx-proxy
```

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- **–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ gRPC –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è**: –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã –±–µ–∑ SSL –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- **–í–Ω–µ—à–Ω–∏–µ REST API**: –í—Å–µ–≥–¥–∞ —á–µ—Ä–µ–∑ HTTPS —Å SSL
- **Docker network**: –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å–µ—Ç—å –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- **Keepalive**: –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- **Health checks**: –¢–æ–ª—å–∫–æ –¥–ª—è nginx, –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã –º–æ–Ω–∏—Ç–æ—Ä—è—Ç—Å—è —á–µ—Ä–µ–∑ Docker 